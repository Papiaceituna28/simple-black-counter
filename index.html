<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador Regresivo</title>
    <style>
        html, body {
            height: 100%;
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            transition: background 0.7s;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .countdown-container {
            text-align: center;
            width: 100%;
            max-width: 1600px;
            padding: 2vh 1vw;
            box-sizing: border-box;
            background: rgba(0,0,0,0.65);
            border-radius: 18px;
        }
        .countdown {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: baseline;
            font-size: clamp(1.5rem, 7vw, 3.5rem);
            word-break: break-word;
            box-sizing: border-box;
            gap: 0.2em;
        }
        .time {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.12em;
            min-width: 48px;
            max-width: 105px;
        }
        .num,
        .separator {
            font-size: clamp(2.8rem, 11vw, 4rem);
            font-weight: bold;
            line-height: 1.08;
            text-align: center;
        }
        .separator {
            margin: 0 0.08em;
            color: #fff;
        }
        .label {
            font-size: clamp(0.7rem, 3vw, 1rem);
            margin-top: 0.24em;
            color: #ccc;
        }
        .date-input, .final-text-input {
            margin-top: 2vh;
            padding: 0.8em 0.5em;
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
            width: clamp(150px, 35vw, 300px);
            max-width: 100vw;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .final-text-input {
            margin-top: 1vh;
            resize: none;
            height: 2.3em;
            min-height: unset;
            max-height: unset;
            line-height: 1.12;
            font-size: clamp(0.96rem,3vw,1.04rem);
            padding-top: 0.2em;
            padding-bottom: 0.2em;
        }
        .final-text-input,
        .final-text-input:focus {
            outline: none;
        }
        .date-input::placeholder, .final-text-input::placeholder { color: #999; }
        .toggle-date-btn {
            position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.3rem;
            z-index: 10;
        }
        .toggle-date-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }
        .bug-btn,
        .change-bg-btn {
            position: fixed;
            right: 20px;
            border: none;
            border-radius: 8px;
            padding: 0.6em 1.2em;
            font-size: 1rem;
            color: #fff;
            background: #4B1818; /* Un rojo oscuro m√°s fuerte */
            box-shadow: 0 2px 8px #0005;
            z-index: 10;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.45em;
            transition: background 0.3s, color 0.2s;
        }
        .change-bg-btn {
            background: rgba(52,52,52,0.84);
            bottom: 80px;
            color: #eee;
        }
        .change-bg-btn:hover {
            background: rgba(90,90,90,0.95);
            color: #f7ea9b;
        }
        .bug-btn {
            bottom: 140px;
            background: #4B1818;
            color: #fff;
        }
        .bug-btn:hover {
            background: #9b1c23;
            color: #fff;
        }
        .date-input.hidden,
        .final-text-input.hidden,
        .bg-options.hidden,
        .change-bg-btn.hidden,
        .bug-btn.hidden {
            display: none !important;
        }
        .byline {
            position: fixed;
            left: 18px;
            bottom: 18px;
            color: #888;
            font-size: clamp(0.74rem, 2.2vw, 1.08rem);
            z-index: 5;
            text-align: left;
            user-select: none;
            text-shadow: 1px 1px 1px #000a;
        }
        .byline a {
            color: #aaa;
            text-decoration: none;
            transition: color 0.2s;
        }
        .byline a:hover {
            color: #fff;
            text-decoration: underline;
        }
        .bg-options {
            position: fixed;
            right: 20px;
            bottom: 200px;
            background: #232323ee;
            padding: 1.4em 1.2em 1.4em 1.2em;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 0.75em;
            box-shadow: 0 2px 18px #0009;
            z-index: 100;
            min-width: 210px;
        }
        .bg-options label {
            color: #e6e6e6;
            font-size: 1rem;
            margin-bottom: 0.19em;
        }
        .bg-options input[type="text"],
        .bg-options input[type="file"],
        .bg-options input[type="checkbox"] {
            font-size: 1rem;
        }
        .bg-options input[type="checkbox"] {
            accent-color: #f8f8b2;
            width: 1.3em;
            height: 1.3em;
            vertical-align: middle;
            margin-right: 0.3em;
        }
        .bg-options input[type="file"] {
            color: #fff;
        }
        /* --- MINIATURAS DE FONDO --- */
        .bg-previews-grid {
            display: flex;
            flex-direction: row;
            gap: 0.5em;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.7em;
            flex-wrap: wrap;
        }
        .bg-preview-btn {
            border: 2px solid transparent;
            cursor: pointer;
            padding: 0;
            border-radius: 7px;
            outline: none;
            transition: border-color 0.2s;
            background: none;
            width: 50px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bg-preview-btn.selected {
            border: 2px solid #fff48b;
        }
        .bg-preview-img {
            width: 46px;
            height: 34px;
            object-fit: cover;
            border-radius: 5px;
            box-shadow: 0 1px 3px #0008;
        }
        .bg-solid-btn {
            width: 46px;
            height: 34px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            display: inline-block;
            margin: 0;
            background: #222;
            transition: border-color 0.2s, background 0.2s;
        }
        .bg-solid-btn.selected {
            border-color: #fff48b;
        }
        .bg-solid-btn .color-sample {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 5px;
        }
        .color-picker {
            margin-left: 0.4em;
            border: none;
            padding: 0;
            background: none;
            width: 44px;
            height: 32px;
            cursor: pointer;
            vertical-align: middle;
        }
        .bg-options .bg-btns {
            margin-top: 0.8em;
            display: flex;
            gap: 0.6em;
        }
        .bg-options button {
            border: none;
            border-radius: 5px;
            padding: 0.45em 1.1em;
            font-size: 1rem;
            background: #3d3d3d;
            color: #eee;
            cursor: pointer;
            transition: background 0.22s;
        }
        .bg-options button:hover {
            background: #67676a;
            color: #fafafa;
        }
        .bg-options small {
            color: #bdbdbd;
            font-size: 0.85em;
        }
        /* --- COPOS DE NIEVE --- */
        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            pointer-events: none;
            z-index: 20;
            display: block;
        }
        @media (max-width: 480px) {
            .countdown-container { max-width: 100vw; padding: 1vh 0.5vw; }
            .toggle-date-btn { right: 10px; bottom: 10px; width: 38px; height: 38px; font-size: 1rem; }
            .change-bg-btn { bottom: 60px; right: 10px; font-size: 0.92rem; padding: 0.5em 0.7em; }
            .bug-btn { bottom: 110px; right: 10px; font-size: 0.92rem; padding: 0.5em 0.7em; }
            .bg-options { right: 7px; bottom: 140px; min-width: 140px; padding: 1em 0.55em 1em 0.55em; }
            .byline { left: 7px; bottom: 7px; font-size: 0.8rem; }
            .date-input, .final-text-input { font-size: 0.99rem; }
            .bg-preview-btn, .bg-solid-btn { width: 33px; height: 28px; }
            .bg-preview-img { width: 29px; height: 23px; }
        }
    </style>
</head>
<body>
    <!-- Canvas para los copos de nieve -->
    <canvas id="snow-canvas"></canvas>

    <div class="countdown-container">
        <div id="timePrefix" style="font-size: clamp(1.5rem, 7vw, 3.5rem); margin-bottom: 1.5rem; display: none;">Hace</div>
        <div class="countdown">
            <div class="time">
                <span class="num" id="years">00</span>
                <div class="label">a√±os</div>
            </div>
            <span class="separator">:</span>
            <div class="time">
                <span class="num" id="months">00</span>
                <div class="label">meses</div>
            </div>
            <span class="separator">:</span>
            <div class="time">
                <span class="num" id="days">00</span>
                <div class="label">d√≠as</div>
            </div>
            <span class="separator">:</span>
            <div class="time">
                <span class="num" id="hours">00</span>
                <div class="label">horas</div>
            </div>
            <span class="separator">:</span>
            <div class="time">
                <span class="num" id="minutes">00</span>
                <div class="label">minutos</div>
            </div>
            <span class="separator">:</span>
            <div class="time">
                <span class="num" id="seconds">00</span>
                <div class="label">segundos</div>
            </div>
            <span class="separator">:</span>
            <div class="time">
                <span class="num" id="milliseconds">00</span>
                <div class="label">milisegundos</div>
            </div>
        </div>
        <input type="datetime-local" id="targetDateInput" class="date-input hidden" value="2026-01-01T00:00" />
        <input 
            type="text"
            id="finalTextInput"
            class="final-text-input hidden"
            maxlength="120"
            spellcheck="true"
            placeholder="Texto al finalizar el contador"
            autocomplete="off"
        />
        <button class="toggle-date-btn" id="toggleDateBtn" title="Mostrar/ocultar selector de fecha">‚öôÔ∏è</button>
        <button class="change-bg-btn hidden" id="changeBgBtn" title="Cambiar fondo">üñºÔ∏è Fondo</button>
        <a href="https://github.com/Papiaceituna28/simple-black-counter/pulls" id="bugBtn" class="bug-btn hidden" title="Reportar bug" target="_blank" rel="noopener">
            <span aria-hidden="true">üêû</span>
            <span style="font-size:0.97em;">Reportar bug</span>
        </a>
        <div class="bg-options hidden" id="bgOptions">
            <label style="margin-bottom: 0.4em;">Im√°genes predeterminadas:</label>
            <div class="bg-previews-grid" id="bgPreviewsGrid">
                <button class="bg-preview-btn" type="button" data-bg='https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/1.webp' title="Fondo 1"><img src="https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/1.webp" class="bg-preview-img" alt="1"/></button>
                <button class="bg-preview-btn" type="button" data-bg='https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/2.webp' title="Fondo 2"><img src="https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/2.webp" class="bg-preview-img" alt="2"/></button>
                <button class="bg-preview-btn" type="button" data-bg='https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/3.webp' title="Fondo 3"><img src="https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/3.webp" class="bg-preview-img" alt="3"/></button>
                <button class="bg-preview-btn" type="button" data-bg='https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/4.webp' title="Fondo 4"><img src="https://raw.githubusercontent.com/Papiaceituna28/simple-black-counter/refs/heads/main/pictures/4.webp" class="bg-preview-img" alt="4"/></button>
                <!-- Colores s√≥lidos: bot√≥n m√°s icono -->
                <button class="bg-solid-btn" type="button" id="bgSolidBtn" title="Seleccionar color s√≥lido">
                    <span class="color-sample" id="colorSample" style="background: #222;"></span>
                </button>
                <input type="color" id="colorPicker" class="color-picker" title="Elige color" value="#232323" />
            </div>
            <label for="bgUrl">Fondo desde enlace (url):</label>
            <input type="text" id="bgUrl" placeholder="https://ejemplo.com/fondo.jpg">
            <label for="bgFile" style="margin-top: 0.8em;">o desde tu equipo:</label>
            <input type="file" id="bgFile" accept="image/*">
            <div style="margin-bottom:0.3em;margin-top:0.7em;">
                <label style="font-size:0.98em;cursor:pointer;user-select:none;">
                    <input type="checkbox" id="snowToggle" checked />
                    Copos de nieve animados
                </label>
            </div>
            <div class="bg-btns">
                <button id="applyBgBtn">Aplicar</button>
                <button id="clearBgBtn" type="button">Quitar fondo</button>
            </div>
            <small>El fondo se guardar√° y se mantendr√° al volver a abrir la p√°gina.</small>
        </div>
    </div>
    <div class="byline">
        By <a href="https://github.com/Papiaceituna28" target="_blank" rel="noopener noreferrer">Papiaceituna</a>
    </div>
    <script>
        // ------ CONTADOR ------
        const LS_FINAL_TEXT = "customFinalText";
        const LS_TARGET_DATE = "customTargetDate";
        const LS_SNOW = "enableSnow";
        const pageLoadDate = new Date();
        let storedDateValue = localStorage.getItem(LS_TARGET_DATE);
        let targetDate = storedDateValue ? new Date(storedDateValue) : new Date('2026-01-01T00:00:00');
        let interval;
        let wasDateManuallySet = !!storedDateValue;

        const defaultFinalText = "¬°Feliz A√±o Nuevo!";
        let finalCountdownText = localStorage.getItem(LS_FINAL_TEXT) || defaultFinalText;
        const finalTextInput = document.getElementById('finalTextInput');
        finalTextInput.value = localStorage.getItem(LS_FINAL_TEXT) || "";

        function updateCountdown() {
            const now = new Date();
            const difference = targetDate - now;
            if (targetDate < pageLoadDate && wasDateManuallySet) {
                document.getElementById('timePrefix').style.display = 'block';
                const reverseDifference = now - targetDate;
                const years = Math.floor(reverseDifference / (1000 * 60 * 60 * 24 * 365));
                const months = Math.floor((reverseDifference % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
                const days = Math.floor((reverseDifference % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((reverseDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((reverseDifference % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((reverseDifference % (1000 * 60)) / 1000);
                const milliseconds = Math.floor(reverseDifference % 1000);
                document.getElementById('years').textContent = String(years).padStart(2, '0');
                document.getElementById('months').textContent = String(months).padStart(2, '0');
                document.getElementById('days').textContent = String(days).padStart(2, '0');
                document.getElementById('hours').textContent = String(hours).padStart(2, '0');
                document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
                document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
                document.getElementById('milliseconds').textContent = String(milliseconds).padStart(3, '0').slice(0, 2);
            } else {
                document.getElementById('timePrefix').style.display = 'none';
                if (difference < 0) {
                    clearInterval(interval);
                    document.querySelector('.countdown').textContent = finalCountdownText || defaultFinalText;
                    return;
                }
                const years = Math.floor(difference / (1000 * 60 * 60 * 24 * 365));
                const months = Math.floor((difference % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
                const days = Math.floor((difference % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((difference % (1000 * 60)) / 1000);
                const milliseconds = Math.floor(difference % 1000);
                document.getElementById('years').textContent = String(years).padStart(2, '0');
                document.getElementById('months').textContent = String(months).padStart(2, '0');
                document.getElementById('days').textContent = String(days).padStart(2, '0');
                document.getElementById('hours').textContent = String(hours).padStart(2, '0');
                document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
                document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
                document.getElementById('milliseconds').textContent = String(milliseconds).padStart(3, '0').slice(0, 2);
            }
        }
        const targetDateInput = document.getElementById('targetDateInput');
        if (storedDateValue) {
            targetDateInput.value = (function(date){
                const pad = v=>String(v).padStart(2,"0");
                return date.getFullYear()+"-"+pad(date.getMonth()+1)+"-"+pad(date.getDate())+"T"+pad(date.getHours())+":"+pad(date.getMinutes());
            })(targetDate);
        }
        targetDateInput.addEventListener('change', function() {
            targetDate = new Date(this.value);
            wasDateManuallySet = true;
            localStorage.setItem("customTargetDate", this.value);
            clearInterval(interval);
            interval = setInterval(updateCountdown, 100);
            updateCountdown();
        });
        finalTextInput.addEventListener('input', function() {
            finalCountdownText = this.value.trim() || defaultFinalText;
            localStorage.setItem("customFinalText", this.value.trim());
        });
        interval = setInterval(updateCountdown, 100);
        updateCountdown();

        // ---- MEN√ö FECHA, BOT√ìN FONDO Y BUG ----
        const toggleBtn = document.getElementById('toggleDateBtn');
        const changeBgBtn = document.getElementById('changeBgBtn');
        const bugBtn = document.getElementById('bugBtn');
        targetDateInput.classList.add('hidden');
        changeBgBtn.classList.add('hidden');
        bugBtn.classList.add('hidden');
        finalTextInput.classList.add('hidden');
        toggleBtn.addEventListener('click', function() {
            const isNowShown = targetDateInput.classList.toggle('hidden') === false;
            if (isNowShown) {
                changeBgBtn.classList.remove('hidden');
                bugBtn.classList.remove('hidden');
                finalTextInput.classList.remove('hidden');
            } else {
                changeBgBtn.classList.add('hidden');
                bugBtn.classList.add('hidden');
                finalTextInput.classList.add('hidden');
                document.getElementById('bgOptions').classList.add('hidden');
            }
        });

        // ------- FONDO PERSONALIZADO -------
        const bgOptions = document.getElementById('bgOptions');
        const applyBgBtn = document.getElementById('applyBgBtn');
        const clearBgBtn = document.getElementById('clearBgBtn');
        const bgUrlInput = document.getElementById('bgUrl');
        const bgFileInput = document.getElementById('bgFile');
        // Agregados para preview y color s√≥lido
        const bgPreviewsGrid = document.getElementById('bgPreviewsGrid');
        const colorPicker = document.getElementById('colorPicker');
        const bgSolidBtn = document.getElementById('bgSolidBtn');
        const colorSample = document.getElementById('colorSample');
        let selectedPreviewBtn = null;
        let selectedColor = colorPicker.value;

        function setBodyBackground(bgData, type = "") {
            if (type === "solid") {
                document.body.style.backgroundImage = "none";
                document.body.style.backgroundColor = bgData;
            } else if (bgData) {
                // Asegura formato correcto: 'url("...")'
                if (bgData.startsWith('url(')) {
                    document.body.style.backgroundImage = bgData;
                } else {
                    document.body.style.backgroundImage = 'url("' + bgData + '")';
                }
                document.body.style.backgroundColor = "#000";
            } else {
                document.body.style.backgroundImage = '';
                document.body.style.backgroundColor = "#000";
            }
        }
        function restoreBackground() {
            const localBgType = localStorage.getItem('customBackgroundType') || '';
            const localBg = localStorage.getItem('customBackground');
            if (localBg) {
                if (localBgType === 'file' || localBgType === 'url') {
                    // Puede estar en 'url("...")' o solo archivo, ajusta:
                    if (localBg.startsWith('url(')) {
                        setBodyBackground(localBg);
                    } else {
                        setBodyBackground(localBg, "image");
                    }
                } else if (localBgType === 'solid') {
                    setBodyBackground(localBg, 'solid');
                    if (colorSample) colorSample.style.background = localBg;
                    if (colorPicker) colorPicker.value = localBg;
                }
            } else {
                setBodyBackground('');
            }
        }

        // Restaura el fondo SOLO una vez al cargar
        restoreBackground();

        changeBgBtn.addEventListener('click', function(e) {
            bgOptions.classList.toggle('hidden');
            e.stopPropagation();
        });
        applyBgBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Si seleccionaste una de las im√°genes predeterminadas:
            if (selectedPreviewBtn && selectedPreviewBtn.classList.contains('bg-preview-btn')) {
                const src = selectedPreviewBtn.getAttribute('data-bg');
                const urlSrc = 'url("' + src + '")';
                localStorage.setItem('customBackgroundType', 'url');
                localStorage.setItem('customBackground', urlSrc);
                setBodyBackground(urlSrc);
                return;
            }
            // Si elegiste color s√≥lido
            if (selectedPreviewBtn && selectedPreviewBtn.classList.contains('bg-solid-btn')) {
                localStorage.setItem('customBackgroundType', 'solid');
                localStorage.setItem('customBackground', selectedColor);
                setBodyBackground(selectedColor, "solid");
                return;
            }
            // Por URL:
            const url = bgUrlInput.value.trim();
            const file = bgFileInput.files[0];
            if (url.length > 6 && (url.startsWith('http://') || url.startsWith('https://'))) {
                const urlSrc = 'url("' + url + '")';
                localStorage.setItem('customBackgroundType', 'url');
                localStorage.setItem('customBackground', urlSrc);
                setBodyBackground(urlSrc);
                bgFileInput.value = '';
                return;
            }
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const dataUrl = ev.target.result;
                    const urlSrc = 'url("' + dataUrl + '")';
                    localStorage.setItem('customBackgroundType', 'file');
                    localStorage.setItem('customBackground', urlSrc);
                    setBodyBackground(urlSrc);
                    bgUrlInput.value = '';
                };
                reader.readAsDataURL(file);
                return;
            }
            alert("Por favor, selecciona un fondo de la parte superior, un color s√≥lido, pon una url o selecciona una imagen del dispositivo.");
        });
        clearBgBtn.addEventListener('click', function() {
            localStorage.removeItem('customBackground');
            localStorage.removeItem('customBackgroundType');
            setBodyBackground('');
            bgUrlInput.value = '';
            bgFileInput.value = '';
            [...bgPreviewsGrid.querySelectorAll('.selected')].forEach(el=>el.classList.remove('selected'));
        });

        // --- MINIATURAS Y COLOR S√ìLIDO ---
        // Selecci√≥n mutua de preview
        bgPreviewsGrid.addEventListener('click', function(e) {
            let btn = e.target;
            if (btn.classList && !btn.classList.contains('bg-preview-btn') && !btn.classList.contains('bg-solid-btn')) {
                btn = btn.closest('.bg-preview-btn,.bg-solid-btn');
            }
            if (!btn || !(btn.classList.contains('bg-preview-btn') || btn.classList.contains('bg-solid-btn'))) return;
            [...bgPreviewsGrid.querySelectorAll('.selected')].forEach(el=>el.classList.remove('selected'));
            btn.classList.add('selected');
            selectedPreviewBtn = btn;
            if (btn.classList.contains('bg-solid-btn')) {
                colorSample.style.background = colorPicker.value;
            }
        });
        colorPicker.addEventListener('input', function(e) {
            selectedColor = e.target.value;
            colorSample.style.background = selectedColor;
            if (selectedPreviewBtn && selectedPreviewBtn.classList.contains('bg-solid-btn')) {
                localStorage.setItem('customBackgroundType', 'solid');
                localStorage.setItem('customBackground', selectedColor);
                setBodyBackground(selectedColor, "solid");
            }
        });
        colorPicker.addEventListener('click', function(e) {
            if (!selectedPreviewBtn || !selectedPreviewBtn.classList.contains('bg-solid-btn')) {
                [...bgPreviewsGrid.querySelectorAll('.selected')].forEach(el=>el.classList.remove('selected'));
                bgSolidBtn.classList.add('selected');
                selectedPreviewBtn = bgSolidBtn;
            }
        });

        bgSolidBtn.addEventListener('click', function(e) {
            [...bgPreviewsGrid.querySelectorAll('.selected')].forEach(el=>el.classList.remove('selected'));
            bgSolidBtn.classList.add('selected');
            selectedPreviewBtn = bgSolidBtn;
            colorPicker.focus();
        });

        bgPreviewsGrid.addEventListener('click', function(e) {
            let btn = e.target;
            if (btn.classList && !btn.classList.contains('bg-preview-btn') && !btn.classList.contains('bg-solid-btn')) {
                btn = btn.closest('.bg-preview-btn,.bg-solid-btn');
            }
            if (btn && btn.classList.contains('bg-preview-btn')) {
                bgUrlInput.value = "";
                bgFileInput.value = "";
            } else if (btn && btn.classList.contains('bg-solid-btn')) {
                bgUrlInput.value = "";
                bgFileInput.value = "";
            }
        });

        bgUrlInput.addEventListener('input', () => {
            [...bgPreviewsGrid.querySelectorAll('.selected')].forEach(el=>el.classList.remove('selected'));
            selectedPreviewBtn = null;
        });
        bgFileInput.addEventListener('input', () => {
            [...bgPreviewsGrid.querySelectorAll('.selected')].forEach(el=>el.classList.remove('selected'));
            selectedPreviewBtn = null;
        });

        document.addEventListener('click', (event) => {
            if (
                !bgOptions.classList.contains('hidden') &&
                !bgOptions.contains(event.target) &&
                event.target !== changeBgBtn
            ) {
                bgOptions.classList.add('hidden');
                [...bgPreviewsGrid.querySelectorAll('.selected')].forEach(el=>el.classList.remove('selected'));
                selectedPreviewBtn = null;
            }
        });
        bgOptions.addEventListener('click', (e) => e.stopPropagation());
        changeBgBtn.addEventListener('click', (e) => e.stopPropagation());
        bgUrlInput.addEventListener('input', ()=>bgFileInput.value='');
        bgFileInput.addEventListener('input', ()=>bgUrlInput.value='');

        if (localStorage.getItem('customBackgroundType') === 'solid') {
            bgSolidBtn.classList.add('selected');
            selectedPreviewBtn = bgSolidBtn;
            if (localStorage.getItem('customBackground')) {
                colorPicker.value = localStorage.getItem('customBackground');
                colorSample.style.background = colorPicker.value;
                selectedColor = colorPicker.value;
            }
        }


        // =========== NIEVE ===============
        const snowCanvas = document.getElementById('snow-canvas');
        let snowAnimationActive = true; // Predeterminado activo
        const snowDefault = (localStorage.getItem(LS_SNOW) === null) ? true : (localStorage.getItem(LS_SNOW) === "true");
        let snowflakes = [];
        let snowCtx = null;
        let snowW = 0;
        let snowH = 0;
        const snowToggle = document.getElementById('snowToggle');
        snowToggle.checked = snowDefault;

        function resizeSnowCanvas() {
            snowW = window.innerWidth;
            snowH = window.innerHeight;
            snowCanvas.width = snowW;
            snowCanvas.height = snowH;
        }

        function getSnowflakeCount() {
            // Aumenta base y ajusta tambi√©n a pantallas peque√±as
            // 70 copos por cada 1000px de ancho, con m√≠nimo 70: set upper at 400
            const base = Math.max(70, Math.floor(snowW * snowH / 4000));
            return Math.min(400, base);
        }

        function getSnowflakeRadiusPx() {
            // Tama√±o relativo a la pantalla (vmin).
            // Entre 0.7vw y 2.6vw, pero ajusta con min/max.
            const minVmin = Math.min(snowW, snowH);
            // Tama√±o m√≠nimo y m√°ximo de copo en px
            const minSize = Math.max(1, Math.round(minVmin * 0.006));
            const maxSize = Math.max(minSize + 1, Math.round(minVmin * 0.022));
            return [minSize, maxSize];
        }

        function createSnowflakes() {
            const N = getSnowflakeCount();
            const [minR, maxR] = getSnowflakeRadiusPx();
            snowflakes.length = 0;
            for(let i = 0; i < N; ++i) {
                // M√°s copos y tama√±os proporcionales a la pantalla
                const r = Math.random() * (maxR-minR) + minR;
                snowflakes.push({
                    x: Math.random() * snowW,
                    y: Math.random() * snowH,
                    r: r, // radius en px
                    d: Math.random() * 0.7 + 0.9, // densidad/speed factor, rango mayor
                    vx: (Math.random()-0.5) * 0.8,
                });
            }
        }

        function drawSnowflakes() {
            snowCtx.clearRect(0, 0, snowW, snowH);
            snowCtx.globalAlpha = 0.90;
            snowCtx.fillStyle = "#fff";
            for(const f of snowflakes) {
                snowCtx.beginPath();
                snowCtx.arc(f.x, f.y, f.r, 0, Math.PI*2, true);
                snowCtx.closePath();
                snowCtx.fill();
            }
        }
        function updateSnowflakes() {
            for(const f of snowflakes) {
                f.y += (f.d + f.r * 0.13); // velocidad un poco proporcional al tama√±o
                f.x += f.vx;
                if(f.y > snowH + f.r) {
                    f.y = -f.r;
                    f.x = Math.random() * snowW;
                }
                if(f.x < -f.r) f.x = snowW + f.r;
                if(f.x > snowW + f.r) f.x = -f.r;
            }
        }
        let snowAnimFrameId = null;
        function snowLoop() {
            updateSnowflakes();
            drawSnowflakes();
            snowAnimFrameId = requestAnimationFrame(snowLoop);
        }
        function startSnow() {
            snowCanvas.style.display = "block";
            resizeSnowCanvas();
            createSnowflakes();
            if(!snowCtx) snowCtx = snowCanvas.getContext('2d');
            if(snowAnimFrameId) cancelAnimationFrame(snowAnimFrameId);
            snowLoop();
        }
        function stopSnow() {
            snowCanvas.style.display = "none";
            if(snowAnimFrameId) cancelAnimationFrame(snowAnimFrameId);
            snowAnimFrameId = null;
            if(snowCtx) snowCtx.clearRect(0,0,snowW,snowH);
        }
        function setSnowActive(active) {
            snowAnimationActive = active;
            if (active) startSnow();
            else stopSnow();
            localStorage.setItem(LS_SNOW, active ? "true" : "false");
        }
        snowToggle.addEventListener('change', function() {
            setSnowActive(this.checked);
        });
        window.addEventListener('resize', function(){
            if(snowAnimationActive) {
                resizeSnowCanvas();
                createSnowflakes();
            }
        });
        setTimeout(()=>{
            if(snowDefault) setSnowActive(true);
            else setSnowActive(false);
        }, 1);
    </script>
</body>
</html>

